var t3vinprefix=".tx-vinou ",vinouShop={addForms:t3vinprefix+"form.add-item-form",card:document.querySelector(".basket-status"),dropper:null,sum:{quantity:0},config:{basket:{messageType:"toast"}},quantity:0,checkBasketTimeout:null,deleteItemButtons:t3vinprefix+"a.delete-basket-item",init:function(){this.bindEvents(),this.createDropper(),this.initBasket()},createDropper:function(){this.dropper=document.createElement("DIV"),this.dropper.id="basket-dropper",document.body.appendChild(this.dropper)},initBasket:function(){for(var e=this,t=document.querySelectorAll("*[data-basket-quantity]"),a=0;a<t.length;a++)e.sum.quantity=t[a].getAttribute("data-basket-quantity"),t[a].remove(),e.updateBasketSum();t.length||e.updateBasketCount()},addItemToBasket:function(e){var t=this,a=document.querySelector(".wine-details"),n=document.getElementById("shop-list-item-"+e.item_id);if(!a&&!n)return!1;var r=a||n,s=r.querySelector(".image img").cloneNode(!0);t.dropper.setAttribute("data-status","visible"),t.dropper.innerHTML="",t.dropper.appendChild(s);var i=r.querySelector(".add-item-form").getBoundingClientRect();t.dropper.style.top=parseInt(i.top)+"px",t.dropper.style.left=parseInt(i.left)+"px";var o=document.querySelector(".basket-status .juwel").getBoundingClientRect();t.dropper.setAttribute("data-status","tobasket"),t.dropper.style.top=parseInt(o.top)+"px",t.dropper.style.left=parseInt(o.left)+"px";setTimeout((function(){t.dropper.setAttribute("data-status","hidden")}),800);var u={data:e};t.basketAction("addItemWithInit",u,(function(){if(200===this.status){switch("string"==typeof t.config.basket.messageType?t.config.basket.messageType:"toast"){case"dialog":switch(e.item_type){case"bundle":var a=e.quantity+" Weinpaket(e) ";break;case"product":a=e.quantity+" Stück ";break;default:a=e.quantity+" Flasche(n) "}new vDialog({title:'<span class="fa fa-shopping-cart"></span> Warenkorb',description:"<strong>"+a+"</strong> wurde(n) in den Warenkorb gelegt.",yes:"OK",type:"OK",ok:function(){}});break;case"toast":toast.show("Erfolgreich","Deine Position wurde in den Warenkorb gelegt")}response=JSON.parse(this.responseText),t.updateBasketCount();var n=document.querySelector("#shop-list-item-"+e.item_id+" .basket-overlay");if(n){response=JSON.parse(this.responseText),n.setAttribute("data-status","visible");for(var r=n.querySelectorAll("input"),s=0;s<r.length;s++)response.data[r[s].name]&&(r[s].value=response.data[r[s].name],"quantity"==r[s].name&&t.refreshQuantityOverlay(r[s]))}}}))},updateBasketCount:function(){var e=this;e.card.setAttribute("data-status","normal"),e.basketAction("getBasketSummary",{},(function(){200==this.status&&(response=JSON.parse(this.responseText),!1!==response.summary&&response.summary.quantity&&(e.sum.quantity=response.summary.quantity,e.updateBasketSum()))}))},updateBasketSum:function(){var e=this;document.querySelector(".basket-status .juwel").innerHTML=e.sum.quantity,e.quantity=e.sum.quantity,e.card.setAttribute("data-status","updated"),clearTimeout(e.checkBasketTimeout),e.checkBasketTimeout=setTimeout((function(){e.checkBasketTableVisibility()}),400)},checkBasketTableVisibility:function(){var e=document.getElementById("basket-table");e&&0===this.quantity&&e.parentNode.removeChild(e)},setBasketError:function(e){var t=this,a=document.getElementById(t3vinprefix+"basket-errors"),n=document.querySelector(t3vinprefix+".basket-controls");if(a){a.innerHTML="";var r="visible";if(t.errors[e]){var s=document.createElement("P");s.className="inline-message basket-warnings",s.setAttribute("data-type",t.errors[e].type);var i=document.createElement("SPAN");i.className="title",i.innerHTML=t.errors[e].title,s.appendChild(i);var o=t.settings[e],u=document.createElement("SPAN");u.className="description","string"!=typeof o&&(o=t.settings[e].join(", ")),t.isNumeric(t.settings[e])>0&&"packageSteps"==e?u.innerHTML=t.errors[e].factor.replace("###value###",o):u.innerHTML=t.errors[e].description.replace("###value###",o),s.appendChild(u),a.appendChild(s),s.setAttribute("data-status","visible"),r=t.errors[e].checkout}n&&n.setAttribute("data-status",r)}},basketAction:function(e,t,a){var n=Array.prototype.slice.call(arguments,3),r=new XMLHttpRequest;r.onload=function(){if(4===r.readyState)if(r.status,401===r.status)localStorage.removeItem("token"),a.apply(r,n);else a.apply(r,n)},r.callback=a,t.action=e,r.open("POST","/?vinou-command",!0),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(t))},refreshQuantityOverlay:function(e){var t=e.closest("form").querySelector(".quantity-overlay");t&&(t.innerHTML=parseInt(e.value))},submitAddForm:function(e){var t=this;0===t.quantity?new vDialog({title:"Altersabfrage",description:"Gerne liefern wir Dir Deine Weine. Bitte bestätige uns, dass Du dafür die notwendigen Altersbeschränkungen erfüllst.",yes:"Ja, ich bin 18",no:"Abbrechen",ok:function(){t.addItemToBasket(t.serializeForm(e))}}):t.addItemToBasket(t.serializeForm(e))},bindEvents:function(){for(var e=this,t=document.querySelectorAll(e.addForms),a=0;a<t.length;a++){t[a].addEventListener?t[a].addEventListener("submit",(function(t){t.preventDefault(),e.submitAddForm(this)}),!0):t[a].attachEvent("onsubmit",(function(t){t.preventDefault(),e.submitAddForm(this)})),t[a].querySelector(".add-basket").addEventListener("click",(function(t){t.preventDefault(),e.submitAddForm(this.closest("form"))})),t[a].querySelector('[name="quantity"]').addEventListener("change",(function(t){e.refreshQuantityOverlay(this)}))}var n=document.querySelectorAll(t3vinprefix+"form");for(a=0;a<n.length;a++)n[a].addEventListener?n[a].addEventListener("submit",(function(t){e.disableForm(this)}),!0):n[a].attachEvent("onsubmit",(function(t){e.disableForm(this)}));var r=document.querySelectorAll(t3vinprefix+'[name="quantity"]');for(a=0;a<r.length;a++)r[a].addEventListener("change",(function(t){var a=this.closest(".article-row"),n=a.getAttribute("data-item-id");a.querySelector('input[data-item-id="'+n+'"]').value=this.value;var r=a.querySelector(".quantity-overlay");r&&(r.innerHTML=parseInt(this.value)),e.setBasketValidation(!1)}));var s=document.querySelectorAll(t3vinprefix+"button.inc,"+t3vinprefix+"button.dec");for(a=0;a<s.length;a++)s[a].addEventListener("click",(function(t){var a=this.closest(".article-row"),n=a.getAttribute("data-item-id"),r=a.querySelector('input[data-item-id="'+n+'"]'),s=a.querySelector('select[name="quantity"]'),i=a.querySelector(".quantity-overlay"),o=r.getAttribute("data-min")?parseInt(r.getAttribute("data-min")):0,u=r.getAttribute("data-max")?parseInt(r.getAttribute("data-max")):99;t.preventDefault();var l=parseInt(r.value);return this.getAttribute("class").indexOf("inc")>-1&&(r.value=l<u?l+1:u),this.getAttribute("class").indexOf("dec")>-1&&(r.value=l>o?l-1:o),s.value=r.value,i&&(i.innerHTML=parseInt(r.value)),e.setBasketValidation(!1),!1}));var i=document.querySelectorAll(e.deleteItemButtons);for(a=0;a<i.length;a++)i[a].addEventListener("click",(function(t){t.preventDefault();var a=this.closest(".article-row"),n=a.getAttribute("data-supplier-id");return a.parentNode.removeChild(a),0==document.querySelectorAll(t3vinprefix+'.article-row[data-supplier-id="'+n+'"]').length&&document.querySelector('.basket-order-item[data-supplier-id="'+n+'"]').remove(),e.setBasketValidation(!1),!1}));basketRefresh=document.querySelector(t3vinprefix+"a.button-to-refresh"),basketRefresh&&basketRefresh.addEventListener("click",(function(t){t.preventDefault(),document.querySelectorAll(t3vinprefix+".inputBasketAction")[0].value="refreshBasket",e.disableForm(this.closest("form")),this.closest("form").submit()})),basketCheckout=document.querySelector(t3vinprefix+"a.button-to-checkout"),basketCheckout&&basketCheckout.addEventListener("click",(function(t){t.preventDefault(),document.querySelectorAll(t3vinprefix+".inputBasketAction")[0].value="goToCheckout",e.disableForm(this.closest("form")),this.closest("form").submit()}))},disableForm:function(e){var t=e.querySelector('[type="submit"]');t&&(t.disabled=!0);var a=e.querySelector(".spinner-wrapper");a&&void 0!==a&&(a.style.display="block")},serializeForm:function(e){if(e&&"FORM"===e.nodeName){var t,a,n={};for(t=e.elements.length-1;t>=0;t-=1)if(""!==e.elements[t].name)switch(e.elements[t].nodeName){case"INPUT":switch(e.elements[t].type){case"text":case"number":case"email":case"date":case"hidden":case"password":case"button":case"reset":case"submit":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"checkbox":case"radio":e.elements[t].checked&&(n[e.elements[t].name]=encodeURIComponent(e.elements[t].value))}break;case"file":break;case"TEXTAREA":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"SELECT":switch(e.elements[t].type){case"select-one":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"select-multiple":for(a=e.elements[t].options.length-1;a>=0;a-=1)e.elements[t].options[a].selected&&(n[e.elements[t].name]=encodeURIComponent(e.elements[t].options[a].value))}}return n}},setBasketValidation:function(e){var t;e||((t=document.querySelector(t3vinprefix+"a.button-to-checkout"))&&t.parentNode.removeChild(t),(t=document.querySelector(t3vinprefix+"a.button-to-refresh"))&&(t.classList.add("grow"),t.classList.add("refresh-required"),setTimeout((function(){t.classList.remove("grow")}),400)))}};vinouShop.init();