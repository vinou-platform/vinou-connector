var t3vinprefix=".tx-vinou ",vinouShop={addForms:t3vinprefix+"form.add-item-form",updateForms:t3vinprefix+"form.edit-item-form",deleteItemButtons:t3vinprefix+"a.delete-basket-item",quantityEditInputs:t3vinprefix+'form.basket-edit-form input[name="quantity"]',card:document.querySelector(".basket-status"),campaign:{hashInput:document.querySelector("input#campaign-code"),check:null,addButton:document.querySelector("a#add-campaign"),removeButton:document.querySelector("a#remove-campaign"),discount:!1,data:!1},token:null,dropper:null,settings:{minBasketSize:null,packageSteps:null},items:[],sum:{quantity:0,bottles:0,net:0,tax:0,gross:0,valid:!1},config:{basket:{messageType:"toast"}},quantity:0,timeout:null,checkBasketTimeout:null,tempquantity:0,temphash:"",errors:{minBasketSize:{title:"Mindestbestellmenge nicht erreicht",description:"Du hast noch nicht die nötige Mindestbestellmenge von <strong>###value### Flaschen</strong> im Warenkorb",type:"error",checkout:"hidden"},packageSteps:{title:"Falsche Bestellmenge",description:"Die größe Deines Warenkorbes entspricht nicht unseren Versandstaffeln. <strong>Wir versenden ###value### Flaschen.</strong> Du möchtest eine Sondergröße beauftragen oder die passende Versandstaffel ist nicht dabei? Dann setz Dich direkt mit uns in Verbindung.",factor:"Die größe Deines Warenkorbes entspricht nicht unseren Versandstaffeln. <strong>Wir versenden ausschließlich Gesamtmengen die durch ###value### teilbar sind.</strong> Du möchtest eine Sondergröße beauftragen? Dann setz Dich direkt mit uns in Verbindung.",type:"error",checkout:"hidden"}},init:function(){this.loadConfig(),this.bindEvents(),this.loadSettings(),this.createDropper(),this.initBasket()},loadConfig:function(){"undefined"!=typeof vinouConfig&&(this.config=vinouConfig)},loadSettings:function(){var e=this;minBasketSize=e.card.getAttribute("data-minbasketsize"),minBasketSize&&parseInt(minBasketSize)>0&&(e.settings.minBasketSize=minBasketSize),packageSteps=e.card.getAttribute("data-packagesteps"),packageSteps&&""!=packageSteps&&(e.settings.packageSteps=packageSteps.split(","))},createDropper:function(){this.dropper=document.createElement("DIV"),this.dropper.id="basket-dropper",document.body.appendChild(this.dropper)},initBasket:function(){campaignRow=document.getElementById("campaign-row"),campaignRow&&campaignRow.getAttribute("data-hash")?this.loadCampaign():this.updateBasketCount()},addItemToBasket:function(e){var t=this,a=document.querySelector(".wine-details"),n=document.getElementById("shop-list-item-"+e.item_id);if(!a&&!n)return!1;var i=a||n,s=i.querySelector(".image img").cloneNode(!0);t.dropper.setAttribute("data-status","visible"),t.dropper.innerHTML="",t.dropper.appendChild(s);var r=i.querySelector(".add-item-form").getBoundingClientRect();t.dropper.style.top=parseInt(r.top)+"px",t.dropper.style.left=parseInt(r.left)+"px";var o=document.querySelector(".basket-status .juwel").getBoundingClientRect();t.dropper.setAttribute("data-status","tobasket"),t.dropper.style.top=parseInt(o.top)+"px",t.dropper.style.left=parseInt(o.left)+"px";setTimeout((function(){t.dropper.setAttribute("data-status","hidden")}),800);var u={data:e};t.basketAction("addItem",u,(function(){if(200===this.status){switch("string"==typeof t.config.basket.messageType?t.config.basket.messageType:"toast"){case"dialog":switch(e.item_type){case"bundle":var a=e.quantity+" Weinpaket(e) ";break;case"product":a=e.quantity+" Stück ";break;default:a=e.quantity+" Flasche(n) "}new vDialog({title:'<span class="fa fa-shopping-cart"></span> Warenkorb',description:"<strong>"+a+"</strong> wurde(n) in den Warenkorb gelegt.",yes:"OK",type:"OK",ok:function(){}});break;case"toast":toast.show("Erfolgreich","Deine Position wurde in den Warenkorb gelegt")}t.updateBasketCount();var n=document.querySelector("#shop-list-item-"+e.item_id+" .basket-overlay");if(n){response=JSON.parse(this.responseText),n.setAttribute("data-status","visible");for(var i=n.querySelectorAll("input"),s=0;s<i.length;s++)response.data[i[s].name]&&(i[s].value=response.data[i[s].name],"quantity"==i[s].name&&t.refreshQuantityOverlay(i[s]))}}}))},deleteItemFromBasket:function(e,t){var a=this,n={id:e},i=document.getElementById("basket-row-"+e);i&&i.setAttribute("data-status","hidden"),a.basketAction("deleteItem",n,(function(){if(200===this.status){i&&i.parentNode.removeChild(i);var e=document.querySelector("#shop-list-item-"+t+" .basket-overlay");e&&e.setAttribute("data-status","hidden"),toast.show("Erfolgreich","Deine Position wurde gelöscht");var n=document.getElementById("campaign-row");n&&n.getAttribute("data-hash")?a.loadCampaign():a.updateBasketCount()}}))},updateBasketItem:function(e){var t=this,a=t.serializeForm(e),n={id:a.id,data:{quantity:a.quantity}};if(a.quantity>0){var i=document.getElementById("basket-row-"+a.id);if(i){var s=i.querySelector(".quantity-overlay");s&&(s.innerHTML=a.quantity);var r=a.quantity*parseFloat(a.gross);i.querySelector(".price strong").innerHTML=r.toFixed(2).replace(".",",")+" €"}t.basketAction("editItem",n,(function(){if(response=JSON.parse(this.responseText),200===this.status){toast.show("Erfolgreich","Deine Position wurde geändert");var e=document.getElementById("campaign-row");e&&e.getAttribute("data-hash")?t.loadCampaign():t.updateBasketCount()}}))}else t.basketAction("deleteItem",{id:a.id},(function(){if(200===this.status){toast.show("Erfolgreich","Deine Position wurde gelöscht");var e=document.getElementById("campaign-row");e&&e.getAttribute("data-hash")?t.loadCampaign():t.updateBasketCount();var n=document.getElementById("basket-row-"+a.id);n&&n.parentNode.removeChild(n)}}))},updateBasketCount:function(){var e=this;e.card.setAttribute("data-status","normal"),e.sum.net=0,e.sum.tax=0,e.sum.gross=0,e.sum.quantity=0,e.sum.visibleQuantity=0,e.basketAction("get",{},(function(){200==this.status&&(response=JSON.parse(this.responseText),e.sum.valid=!!response.valid&&response.valid,response.basketItems?(response.basketItems.forEach((function(t){var a=1;t.item.package_quantity&&parseInt(t.item.package_quantity)>0&&(a=t.item.package_quantity),e.sum.visibleQuantity+=parseInt(t.quantity),e.sum.quantity+=parseInt(t.quantity)*parseInt(a),t.item.prices&&t.item.prices[0]?(e.sum.tax+=t.quantity*t.item.prices[0].tax,e.sum.net+=t.quantity*t.item.prices[0].net,e.sum.gross+=t.quantity*t.item.prices[0].gross):(e.sum.tax+=t.quantity*t.item.tax,e.sum.net+=t.quantity*t.item.net,e.sum.gross+=t.quantity*t.item.gross)})),e.basketAction("findPackage",{type:"bottles",quantity:e.sum.quantity},(function(){response=JSON.parse(this.responseText),packageRow=document.querySelector("#package-row"),response&&response.gross?(e.sum.tax+=1*response.tax,e.sum.net+=1*response.net,e.sum.gross+=1*response.gross,packageGross=response.gross.replace(".",",")+" €"):packageGross="0,00 €",packageRow&&(packagePrice=packageRow.querySelector(".package-price"),packageRow.setAttribute("data-id",response.id),packagePrice&&(packagePrice.innerHTML=packageGross)),e.updateBasketSum()}))):e.updateBasketSum())}))},updateBasketSum:function(){var e=this,t=document.querySelector(".basket-status");for(var a in t&&(t.setAttribute("data-count",e.sum.quantity),e.sum.quantity?(t.classList.add("filled"),t.classList.remove("empty")):(t.classList.add("empty"),t.classList.remove("filled"))),document.querySelector(".basket-status .juwel").innerHTML=e.sum.visibleQuantity,e.quantity=e.sum.quantity,e.card.setAttribute("data-status","updated"),void 0!==e.campaign.discount.gross&&(e.sum.gross=parseFloat(e.sum.gross)+parseFloat(e.campaign.discount.gross),e.sum.net=parseFloat(e.sum.net)+parseFloat(e.campaign.discount.net),e.sum.tax=parseFloat(e.sum.tax)+parseFloat(e.campaign.discount.tax)),e.sum)e.sum.hasOwnProperty(a)&&(el=document.querySelector("#basket-table #basket-sum-"+a),el&&"number"==typeof e.sum[a]&&(el.innerHTML=e.sum[a].toFixed(2).replace(".",",")+" €"));e.setBasketError(e.sum.valid),clearTimeout(e.checkBasketTimeout),e.checkBasketTimeout=setTimeout((function(){e.checkBasketTableVisibility()}),400)},checkBasketTableVisibility:function(){var e=document.getElementById("basket-table");e&&0===this.quantity&&e.parentNode.removeChild(e)},isNumeric:function(e){return/^-?[\d.]+(?:e-?\d+)?$/.test(e)},setBasketError:function(e){var t=this,a=document.getElementById(t3vinprefix+"basket-errors"),n=document.querySelector(t3vinprefix+".basket-controls");if(a){a.innerHTML="";var i="visible";if(t.errors[e]){var s=document.createElement("P");s.className="inline-message basket-warnings",s.setAttribute("data-type",t.errors[e].type);var r=document.createElement("SPAN");r.className="title",r.innerHTML=t.errors[e].title,s.appendChild(r);var o=t.settings[e],u=document.createElement("SPAN");u.className="description","string"!=typeof o&&(o=t.settings[e].join(", ")),t.isNumeric(t.settings[e])>0&&"packageSteps"==e?u.innerHTML=t.errors[e].factor.replace("###value###",o):u.innerHTML=t.errors[e].description.replace("###value###",o),s.appendChild(u),a.appendChild(s),s.setAttribute("data-status","visible"),i=t.errors[e].checkout}n&&n.setAttribute("data-status",i)}},basketAction:function(e,t,a){var n=Array.prototype.slice.call(arguments,3),i=new XMLHttpRequest;i.onload=function(){if(4===i.readyState)switch(i.status,i.status){case 200:default:a.apply(i,n);break;case 401:localStorage.removeItem("token"),a.apply(i,n)}},i.callback=a,t.action=e,i.open("POST","/?vinou-command",!0),i.setRequestHeader("Content-type","application/json"),i.send(JSON.stringify(t))},refreshQuantityOverlay:function(e){var t=e.closest("form").querySelector(".quantity-overlay");t&&(t.innerHTML=parseInt(e.value))},submitAddForm:function(e){var t=this;0===t.quantity?new vDialog({title:"Altersabfrage",description:"Gerne liefern wir Dir Deine Weine. Bitte bestätige uns, dass Du dafür die notwendigen Altersbeschränkungen erfüllst.",yes:"Ja, ich bin 18",no:"Abbrechen",ok:function(){t.addItemToBasket(t.serializeForm(e))}}):t.addItemToBasket(t.serializeForm(e))},bindEvents:function(){for(var e=this,t=(document.getElementById("basket-dropper"),document.querySelectorAll(e.addForms)),a=0;a<t.length;a++){t[a].addEventListener?t[a].addEventListener("submit",(function(t){t.preventDefault(),e.submitAddForm(this)}),!0):t[a].attachEvent("onsubmit",(function(t){t.preventDefault(),e.submitAddForm(this)})),t[a].querySelector(".add-basket").addEventListener("click",(function(t){t.preventDefault(),e.submitAddForm(this.closest("form"))})),(i=t[a].querySelector('[name="quantity"]')).addEventListener("change",(function(t){e.refreshQuantityOverlay(this)}))}var n=document.querySelectorAll(e.updateForms);for(a=0;a<n.length;a++){var i;n[a].addEventListener?n[a].addEventListener("submit",(function(t){t.preventDefault(),e.updateBasketItem(this)}),!0):n[a].attachEvent("onsubmit",(function(t){t.preventDefault(),e.updateBasketItem(this)})),(i=n[a].querySelector('[name="quantity"]')).addEventListener("focus",(function(t){e.tempquantity=this.value})),i.addEventListener("change",(function(t){e.refreshQuantityOverlay(this),e.setUpdateTimeout(this)})),i.addEventListener("blur",(function(t){e.setUpdateTimeout(this)})),i.addEventListener("input",(function(t){e.setUpdateTimeout(this)}))}var s=document.querySelectorAll(t3vinprefix+"button.inc,"+t3vinprefix+"button.dec");for(a=0;a<s.length;a++)s[a].addEventListener("click",(function(t){t.preventDefault();var a=this.form,n=a.querySelector('[name="quantity"]'),i=a.querySelector('[type="submit"]'),s=parseInt(n.value);if(this.getAttribute("class").indexOf("inc")>-1){var r=n.getAttribute("max")?parseInt(n.getAttribute("max")):99;s<r?(e.tempquantity=s,n.value=s+1):n.value=r}if(this.getAttribute("class").indexOf("dec")>-1){var o=n.getAttribute("min")?parseInt(n.getAttribute("min")):1;s>o?(e.tempquantity=s,n.value=s-1):n.value=o}return e.refreshQuantityOverlay(n),a.getAttribute("class").indexOf("edit-item-form")>-1&&!i&&e.setUpdateTimeout(n),!1}));var r=document.querySelectorAll(e.deleteItemButtons);for(a=0;a<r.length;a++)r[a].addEventListener("click",(function(t){t.preventDefault();var a=this.getAttribute("data-id"),n=this.getAttribute("data-wine-id");return e.deleteItemFromBasket(a,n),!1}));var o=document.querySelector("#deliveryAdress");o&&o.addEventListener("change",(function(){document.querySelector("#delivery-fieldset").setAttribute("data-visible",this.checked?1:0);var e=document.querySelectorAll('#delivery-fieldset [data-required="1"]');this.checked?e.forEach((function(e){e.setAttribute("required","required")})):e.forEach((function(e){e.removeAttribute("required")}))})),e.campaign.hashInput&&e.campaign.hashInput.addEventListener("input",(function(t){e.setCampaignTimeout(this)})),e.campaign.addButton&&e.campaign.addButton.addEventListener("click",(function(t){return t.preventDefault(),e.loadCampaign(),!1})),e.campaign.removeButton&&e.campaign.removeButton.addEventListener("click",(function(t){return t.preventDefault(),e.removeCampaign(),!1}));var u=document.querySelectorAll(t3vinprefix+"form");for(a=0;a<u.length;a++)u[a].addEventListener?u[a].addEventListener("submit",(function(t){e.disableForm(this)}),!0):u[a].attachEvent("onsubmit",(function(t){e.disableForm(this)}))},disableForm:function(e){var t=e.querySelector('[type="submit"]');t&&(t.disabled=!0);var a=e.querySelector(".spinner-wrapper");a&&void 0!==a&&(a.style.display="block")},setUpdateTimeout:function(e){var t=this;clearTimeout(t.timeout),t.timeout=setTimeout((function(){t.tempquantity!=e.value&&e.value>0&&(t.tempquantity=null,t.updateBasketItem(e.form))}),750)},collectBasketData:function(){var e=this;e.items=[];for(var t=document.querySelectorAll(t3vinprefix+".item-row"),a=0;a<t.length;a++){var n=t[a];if("campaign-row"!=n.id){var i=n.querySelector("form");if("package-row"==n.id){var s={item_type:"package",item_id:n.getAttribute("data-id"),quantity:1,net:n.getAttribute("data-net"),tax:n.getAttribute("data-tax"),taxrate:n.getAttribute("data-taxrate"),gross:n.getAttribute("data-gross")};e.items.push(s)}else{if(void 0===i)continue;var r=e.serializeForm(i);(s={quantity:r.quantity,gross:(r.quantity*r.gross).toFixed(2),taxrate:r.taxrate,item_type:r.item_type,item_id:r.item_id}).net=(s.gross/(1+s.taxrate/100)).toFixed(2),s.tax=(s.gross-s.net).toFixed(2),e.items.push(s)}}}},setCampaignTimeout:function(e){var t=this;clearTimeout(t.campaign.check),t.campaign.check=setTimeout((function(){if(t.temphash!=e.value&&""!=e.value){if(e.disabled=!0,"string"==typeof t.campaign.data.hash&&t.campaign.data.hash==e.value)return e.value="",!1;var a=document.querySelector("#campaign-table .loader");a&&a.setAttribute("data-status","visible"),t.temphash=e.value,t.collectBasketData(),t.basketAction("findCampaign",{hash:e.value,items:t.items},(function(){var n=JSON.parse(this.responseText);if(e.disabled=!1,a&&a.setAttribute("data-status","hidden"),200==this.status&&"success"==n.info)t.campaign.addButton.setAttribute("data-status","enabled");else{if(null!=n.errors)var i=null!=typeof n.errors[0]?n.errors[0]:n.data;else if("undefined"!=n.data)i=n.data;else i="";if("ERROR_MIN_QUANTITY_NOT_REACHED"===i)var s="Mindeststückzahl für den Rabatt-Code nicht erreicht!";else s="Rabatt-Code konnte nicht gefunden werden!";toast.show("Fehler!",s),t.campaign.addButton.setAttribute("data-status","disabled")}}))}}),750)},loadCampaign:function(){var e=this,t=!1,a=document.querySelector("#campaign-row");if(a&&""!=a.getAttribute("data-hash")&&(t=a.getAttribute("data-hash")),e.campaign.hashInput&&""!=e.campaign.hashInput.value&&(t=e.campaign.hashInput.value),!t)return!1;e.campaign.data=!1,e.campaign.discount=!1,e.collectBasketData(),e.basketAction("loadCampaign",{hash:t,items:e.items},(function(){var t=JSON.parse(this.responseText);if(200==this.status){e.campaign.data=t.data,e.campaign.discount=t.summary,e.campaign.hashInput.value="",a.setAttribute("data-hash",t.data.hash),e.campaign.addButton.setAttribute("data-status","disabled");var n=document.getElementById("campaign-table");n&&n.setAttribute("data-status","hidden")}else{if("ERROR_MIN_QUANTITY_NOT_REACHED"===(void 0!==t.errors[0]?t.errors[0]:t.data))var i="Mindeststückzahl für den Rabatt-Code nicht erreicht!";else i="Rabatt-Code konnte nicht gefunden werden!";i&&toast.show("Fehler!",i)}e.toggleCampaignRow()}))},removeCampaign:function(){var e=this;e.campaign.data=!1,e.campaign.discount=!1,e.basketAction("removeCampaign",{},(function(){200===this.status&&(e.campaign.data=!1,e.campaign.discount=!1,e.toggleCampaignRow())}))},toggleCampaignRow:function(){var e=this,t=document.getElementById("campaign-row");return!!t&&([{field:"name"},{field:"hash"},{field:"id"},{field:"gross"},{field:"description"},{field:"gross",target:"attribute"},{field:"hash",target:"attribute"}].forEach((function(a){var n=a.field,i=t.querySelector('[data-property="campaign-'+n+'"]');if("gross"==n)var s=e.campaign.discount[n]?e.campaign.discount[n].replace(".",",")+" €":"";else s=e.campaign.data[n]?e.campaign.data[n]:"";"attribute"==a.target?(i=t)&&t.setAttribute("data-"+n,s):i&&(i.innerHTML=s)})),t.setAttribute("data-status",e.campaign.data?"visible":"hidden"),e.updateBasketCount(),!0)},serializeForm:function(e){if(e&&"FORM"===e.nodeName){var t,a,n={};for(t=e.elements.length-1;t>=0;t-=1)if(""!==e.elements[t].name)switch(e.elements[t].nodeName){case"INPUT":switch(e.elements[t].type){case"text":case"number":case"email":case"date":case"hidden":case"password":case"button":case"reset":case"submit":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"checkbox":case"radio":e.elements[t].checked&&(n[e.elements[t].name]=encodeURIComponent(e.elements[t].value))}break;case"file":break;case"TEXTAREA":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"SELECT":switch(e.elements[t].type){case"select-one":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"select-multiple":for(a=e.elements[t].options.length-1;a>=0;a-=1)e.elements[t].options[a].selected&&(n[e.elements[t].name]=encodeURIComponent(e.elements[t].options[a].value))}}return n}},isTouchDevice:function(){var e=" -webkit- -moz- -o- -ms- ".split(" ");return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||function(e){return window.matchMedia(e).matches}(["(",e.join("touch-enabled),("),"heartz",")"].join(""))}};vinouShop.init();