var vinouShop={addForms:"form.add-item-form",updateForms:"form.edit-item-form",deleteItemButtons:"a.delete-basket-item",quantityEditInputs:'form.basket-edit-form input[name="quantity"]',token:null,dropper:null,quantity:0,timeout:null,tempquantity:0,init:function(){this.bindEvents(),this.createDropper(),this.updateBasketCount()},createDropper:function(){this.dropper=document.createElement("DIV"),this.dropper.id="basket-dropper",document.body.appendChild(this.dropper)},addItemToBasket:function(e){var t=this,n=document.querySelector(".wine-details"),a=document.getElementById("shop-list-item-"+e.item_id);if(!n&&!a)return!1;var i=n||a,r=i.querySelector(".image img").cloneNode(!0);t.dropper.setAttribute("data-status","visible"),t.dropper.innerHTML="",t.dropper.appendChild(r);var s=i.getBoundingClientRect();t.dropper.style.top=parseInt(s.top)+"px",t.dropper.style.left=parseInt(s.left)+"px";var o=document.querySelector(".basket-status .juwel").getBoundingClientRect();t.dropper.setAttribute("data-status","tobasket"),t.dropper.style.top=parseInt(o.top)+"px",t.dropper.style.left=parseInt(o.left)+"px";setTimeout((function(){t.dropper.setAttribute("data-status","hidden")}),800);var u={data:e};t.basketAction("addItem",u,(function(){if(200===this.status){toast.show("Erfolgreich","Ihre Position wurde in den Warenkorb gelegt"),t.updateBasketCount();var n=document.querySelector("#shop-list-item-"+e.item_id+" .basket-overlay");if(n){response=JSON.parse(this.responseText),n.setAttribute("data-status","visible");for(var a=n.querySelectorAll("input"),i=0;i<a.length;i++)response.data[a[i].name]&&(a[i].value=response.data[a[i].name])}}}))},deleteItemFromBasket:function(e,t){var n=this,a={id:e},i=document.getElementById("basket-row-"+e);i&&i.setAttribute("data-status","hidden"),n.basketAction("deleteItem",a,(function(){if(200===this.status){toast.show("Erfolgreich","Ihre Position wurde gelöscht"),n.updateBasketCount(),i&&i.parentNode.removeChild(i);var e=document.querySelector("#shop-list-item-"+t+" .basket-overlay");e&&e.setAttribute("data-status","hidden")}}))},updateBasketItem:function(e){var t=this,n={id:e.id,data:{quantity:e.quantity}};if(e.quantity>0){var a=document.getElementById("basket-row-"+e.id);if(a){var i=e.quantity*parseFloat(e.price);a.querySelector(".price strong").innerHTML=i.toFixed(2).replace(".",",")+" EUR"}t.basketAction("editItem",n,(function(){200===this.status&&(toast.show("Erfolgreich","Ihre Position wurde geändert"),t.updateBasketCount())}))}else t.basketAction("deleteItem",{id:e.id},(function(){if(200===this.status){toast.show("Erfolgreich","Ihre Position wurde gelöscht"),t.updateBasketCount();var n=document.getElementById("basket-row-"+e.id);n&&n.parentNode.removeChild(n)}}))},updateBasketCount:function(){var e=this,t=document.querySelector(".basket-status");t.setAttribute("data-status","normal"),e.basketAction("get",{},(function(){if(200==this.status){response=JSON.parse(this.responseText);var n={quantity:0,net:0,tax:0,gross:0};response.basketItems?(response.basketItems.forEach((function(e){n.quantity+=e.quantity,e.item.prices&&e.item.prices[0]?(n.tax+=e.quantity*e.item.prices[0].tax,n.net+=e.quantity*e.item.prices[0].net,n.gross+=e.quantity*e.item.prices[0].gross):(n.tax+=e.quantity*e.item.tax,n.net+=e.quantity*e.item.net,n.gross+=e.quantity*e.item.gross)})),e.basketAction("findPackage",{type:"bottles",quantity:n.quantity},(function(){response=JSON.parse(this.responseText),packagePrice=document.querySelector("#package-row .package-price"),response&&response.gross?(n.tax+=1*response.tax,n.net+=1*response.net,n.gross+=1*response.gross,packageGross=response.gross.replace(".",",")+" EUR"):packageGross="0,00 EUR",packagePrice&&(packagePrice.innerHTML=packageGross),document.querySelector(".basket-status .juwel").innerHTML=n.quantity,e.quantity=n.quantity,t.setAttribute("data-status","updated"),e.updateBasketSum(n);var a=document.getElementById("basket-table");a&&0===e.quantity&&a.parentNode.removeChild(a)}))):(document.querySelector(".basket-status .juwel").innerHTML=n.quantity,e.quantity=n.quantity,t.setAttribute("data-status","updated"),e.updateBasketSum(n))}}))},updateBasketSum:function(e){for(var t in e)e.hasOwnProperty(t)&&(el=document.querySelector("#basket-table #basket-sum-"+t),el&&(el.innerHTML=e[t].toFixed(2).replace(".",",")+" EUR"));var n=document.getElementById("quantity-warning"),a=document.querySelector(".basket-controls");if(n&&a&&a.hasAttribute("data-minbasketsize")){var i=a.getAttribute("data-minbasketsize"),r=e.quantity<i?"hidden":"visible";n.setAttribute("data-checkout",r),a.setAttribute("data-status",r)}},basketAction:function(e,t,n){var a=Array.prototype.slice.call(arguments,3),i=new XMLHttpRequest;i.onload=function(){if(4===i.readyState)switch(i.status){case 200:n.apply(i,a);break;case 401:localStorage.removeItem("token"),n.apply(i,a);break;default:n.apply(i,a)}},i.callback=n,t.action=e,i.open("POST","/?eID=vinouActions",!0),i.setRequestHeader("Content-type","application/json"),i.send(JSON.stringify(t))},submitAddForm:function(e){var t=this;0===t.quantity?new vDialog({title:"Altersabfrage",description:"Gerne liefern wir Ihnen Ihre Weine. Bitte bestätigen Sie uns, dass Sie dafür die notwendigen Altersbeschränkungen erfüllen.",yes:"Ja, ich bin 18",no:"Abbrechen",ok:function(){t.addItemToBasket(t.serializeForm(e))}}):t.addItemToBasket(t.serializeForm(e))},bindEvents:function(){for(var e=this,t=(document.getElementById("basket-dropper"),document.querySelectorAll(e.addForms)),n=0;n<t.length;n++){t[n].addEventListener?t[n].addEventListener("submit",(function(t){t.preventDefault(),e.submitAddForm(this)}),!0):t[n].attachEvent("onsubmit",(function(t){t.preventDefault(),e.submitAddForm(this)})),t[n].querySelector(".add-basket").addEventListener("click",(function(a){a.preventDefault(),e.submitAddForm(t[n])}))}var a=document.querySelectorAll("button.inc");for(n=0;n<a.length;n++)a[n].addEventListener("click",(function(t){t.preventDefault();var n=this.parentNode.querySelector('input[name="quantity"]'),a=n.value;e.tempquantity=a;var i=n.getAttribute("max")?n.getAttribute("max"):99;return n.value=a<i?parseInt(a)+1:i,e.setUpdateTimeout(n),!1}));var i=document.querySelectorAll("button.dec");for(n=0;n<i.length;n++)i[n].addEventListener("click",(function(t){t.preventDefault();var n=this.parentNode.querySelector('input[name="quantity"]'),a=n.value;e.tempquantity=a;var i=n.getAttribute("min")?n.getAttribute("min"):1;return n.value=a>i?parseInt(a)-1:i,e.setUpdateTimeout(n),!1}));var r=document.querySelectorAll(e.updateForms);for(n=0;n<r.length;n++){r[n].addEventListener?r[n].addEventListener("submit",(function(t){t.preventDefault(),e.updateBasketItem(e.serializeForm(this))}),!0):r[n].attachEvent("onsubmit",(function(t){t.preventDefault(),e.updateBasketItem(e.serializeForm(this))}));var s=r[n].querySelector('input[name="quantity"]');s.addEventListener("focus",(function(t){e.tempquantity=this.value})),s.addEventListener("blur",(function(t){e.setUpdateTimeout(this)})),s.addEventListener("input",(function(t){e.setUpdateTimeout(this)}))}var o=document.querySelectorAll(e.deleteItemButtons);for(n=0;n<o.length;n++)o[n].addEventListener("click",(function(t){t.preventDefault();var n=this.getAttribute("data-id"),a=this.getAttribute("data-wine-id");return e.deleteItemFromBasket(n,a),!1}));var u=document.querySelector("#deliveryAdress");u&&u.addEventListener("change",(function(){document.querySelector("#delivery-fieldset").setAttribute("data-visible",this.checked?1:0);var e=document.querySelectorAll('#delivery-fieldset [data-required="1"]');this.checked?e.forEach((function(e){e.setAttribute("required","required")})):e.forEach((function(e){e.removeAttribute("required")}))}))},setUpdateTimeout:function(e){var t=this;t.timeout&&(clearTimeout(t.timeout),t.timeout=null),t.timeout=setTimeout((function(){t.tempquantity!=e.value&&e.value>0&&(t.tempquantity=null,t.updateBasketItem(t.serializeForm(e.form)))}),500)},serializeForm:function(e){if(e&&"FORM"===e.nodeName){var t,n,a={};for(t=e.elements.length-1;t>=0;t-=1)if(""!==e.elements[t].name)switch(e.elements[t].nodeName){case"INPUT":switch(e.elements[t].type){case"text":case"number":case"email":case"date":case"hidden":case"password":case"button":case"reset":case"submit":a[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"checkbox":case"radio":e.elements[t].checked&&(a[e.elements[t].name]=encodeURIComponent(e.elements[t].value))}break;case"file":break;case"TEXTAREA":a[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"SELECT":switch(e.elements[t].type){case"select-one":a[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"select-multiple":for(n=e.elements[t].options.length-1;n>=0;n-=1)e.elements[t].options[n].selected&&(a[e.elements[t].name]=encodeURIComponent(e.elements[t].options[n].value))}}return a}},isTouchDevice:function(){var e=" -webkit- -moz- -o- -ms- ".split(" ");return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||function(e){return window.matchMedia(e).matches}(["(",e.join("touch-enabled),("),"heartz",")"].join(""))}};vinouShop.init();