var vinouShop={addForms:"form.add-item-form",updateForms:"form.edit-item-form",deleteItemButtons:"a.delete-basket-item",quantityEditInputs:'form.basket-edit-form input[name="quantity"]',card:document.querySelector(".basket-status"),campaign:{hashInput:document.querySelector("input#campaign-code"),check:null,addButton:document.querySelector("a#add-campaign"),removeButton:document.querySelector("a#remove-campaign"),discount:!1,data:!1},token:null,dropper:null,settings:{minBasketSize:null,packageSteps:null},quantity:0,timeout:null,tempquantity:0,temphash:"",errors:{minBasketSize:{title:"Mindestbestellmenge nicht erreicht",description:"Du hast noch nicht die nötige Mindestbestellmenge von <strong>###value### Flaschen</strong> im Warenkorb",type:"warning",checkout:"hidden"},packageSteps:{title:"Falsche Bestellmenge",description:"Die größe Deines Warenkorbes entspricht nicht unseren Versandstaffeln. <strong>Wir versenden unsere Ware nur in ###value###er Kartons</strong>.",type:"warning",checkout:"hidden"}},init:function(){this.bindEvents(),this.loadSettings(),this.createDropper(),this.initBasket()},loadSettings:function(){var e=this;minBasketSize=e.card.getAttribute("data-minbasketsize"),minBasketSize&&parseInt(minBasketSize)>0&&(e.settings.minBasketSize=minBasketSize),packageSteps=e.card.getAttribute("data-packagesteps"),packageSteps&&""!=packageSteps&&(e.settings.packageSteps=packageSteps.split(","))},createDropper:function(){this.dropper=document.createElement("DIV"),this.dropper.id="basket-dropper",document.body.appendChild(this.dropper)},initBasket:function(){var e=this;campaignRow=document.getElementById("campaign-row"),campaignRow&&campaignRow.getAttribute("data-hash")?e.basketAction("loadCampaign",{hash:campaignRow.getAttribute("data-hash")},(function(){200===this.status&&(e.campaign.data=JSON.parse(this.responseText),e.updateBasketCount())})):e.updateBasketCount()},addItemToBasket:function(e){var t=this,a=document.querySelector(".wine-details"),n=document.getElementById("shop-list-item-"+e.item_id);if(!a&&!n)return!1;var i=a||n,s=i.querySelector(".image img").cloneNode(!0);t.dropper.setAttribute("data-status","visible"),t.dropper.innerHTML="",t.dropper.appendChild(s);var r=i.querySelector(".add-item-form").getBoundingClientRect();t.dropper.style.top=parseInt(r.top)+"px",t.dropper.style.left=parseInt(r.left)+"px";var o=document.querySelector(".basket-status .juwel").getBoundingClientRect();t.dropper.setAttribute("data-status","tobasket"),t.dropper.style.top=parseInt(o.top)+"px",t.dropper.style.left=parseInt(o.left)+"px";setTimeout((function(){t.dropper.setAttribute("data-status","hidden")}),800);var u={data:e};t.basketAction("addItem",u,(function(){if(200===this.status){toast.show("Erfolgreich","Deine Position wurde in den Warenkorb gelegt"),t.updateBasketCount();var a=document.querySelector("#shop-list-item-"+e.item_id+" .basket-overlay");if(a){response=JSON.parse(this.responseText),a.setAttribute("data-status","visible");for(var n=a.querySelectorAll("input"),i=0;i<n.length;i++)response.data[n[i].name]&&(n[i].value=response.data[n[i].name])}}}))},deleteItemFromBasket:function(e,t){var a=this,n={id:e},i=document.getElementById("basket-row-"+e);i&&i.setAttribute("data-status","hidden"),a.basketAction("deleteItem",n,(function(){if(200===this.status){toast.show("Erfolgreich","Deine Position wurde gelöscht"),a.updateBasketCount(),i&&i.parentNode.removeChild(i);var e=document.querySelector("#shop-list-item-"+t+" .basket-overlay");e&&e.setAttribute("data-status","hidden")}}))},updateBasketItem:function(e){var t=this,a={id:e.id,data:{quantity:e.quantity}};if(e.quantity>0){var n=document.getElementById("basket-row-"+e.id);if(n){var i=e.quantity*parseFloat(e.price);n.querySelector(".price strong").innerHTML=i.toFixed(2).replace(".",",")+" €"}t.basketAction("editItem",a,(function(){200===this.status&&(toast.show("Erfolgreich","Deine Position wurde geändert"),t.updateBasketCount())}))}else t.basketAction("deleteItem",{id:e.id},(function(){if(200===this.status){toast.show("Erfolgreich","Deine Position wurde gelöscht"),t.updateBasketCount();var a=document.getElementById("basket-row-"+e.id);a&&a.parentNode.removeChild(a)}}))},updateBasketCount:function(){var e=this;e.card.setAttribute("data-status","normal"),e.basketAction("get",{},(function(){if(200==this.status){response=JSON.parse(this.responseText);var t={quantity:0,net:0,tax:0,gross:0,valid:!!response.valid&&response.valid};response.basketItems?(response.basketItems.forEach((function(e){"bundle"==e.item_type&&parseInt(e.item.package_quantity)>0?t.quantity+=parseInt(e.quantity)*parseInt(e.item.package_quantity):t.quantity+=e.quantity,e.item.prices&&e.item.prices[0]?(t.tax+=e.quantity*e.item.prices[0].tax,t.net+=e.quantity*e.item.prices[0].net,t.gross+=e.quantity*e.item.prices[0].gross):(t.tax+=e.quantity*e.item.tax,t.net+=e.quantity*e.item.net,t.gross+=e.quantity*e.item.gross)})),e.basketAction("findPackage",{type:"bottles",quantity:t.quantity},(function(){response=JSON.parse(this.responseText),packagePrice=document.querySelector("#package-row .package-price"),response&&response.gross?(t.tax+=1*response.tax,t.net+=1*response.net,t.gross+=1*response.gross,packageGross=response.gross.replace(".",",")+" €"):packageGross="0,00 €",packagePrice&&(packagePrice.innerHTML=packageGross),e.campaign.data?e.basketAction("campaignDiscount",{},(function(){discount=JSON.parse(this.responseText),200===this.status&&(e.campaign.discount=discount,e.toggleCampaignRow(),t.tax+=1*discount.tax,t.net+=1*discount.net,t.gross+=1*discount.gross,e.updateBasketSum(t))})):(e.toggleCampaignRow(),e.updateBasketSum(t))}))):e.updateBasketSum(t)}}))},updateBasketSum:function(e){var t=this;for(var a in document.querySelector(".basket-status .juwel").innerHTML=e.quantity,t.quantity=e.quantity,t.card.setAttribute("data-status","updated"),e)e.hasOwnProperty(a)&&(el=document.querySelector("#basket-table #basket-sum-"+a),el&&(el.innerHTML=e[a].toFixed(2).replace(".",",")+" €"));t.setBasketError(e.valid);var n=document.getElementById("basket-table");n&&0===t.quantity&&n.parentNode.removeChild(n)},setBasketError:function(e){var t=this,a=document.getElementById("basket-errors"),n=document.querySelector(".basket-controls");if(a){a.innerHTML="";var i="visible";if(t.errors[e]){var s=document.createElement("P");s.className="inline-message basket-warnings",s.setAttribute("data-type",t.errors[e].type);var r=document.createElement("SPAN");r.className="title",r.innerHTML=t.errors[e].title,s.appendChild(r);var o=t.settings[e],u=document.createElement("SPAN");u.className="description","string"!=typeof o&&(o=t.settings[e].join(", ")),u.innerHTML=t.errors[e].description.replace("###value###",o),s.appendChild(u),a.appendChild(s),s.setAttribute("data-status","visible"),i=t.errors[e].checkout}n&&n.setAttribute("data-status",i)}},basketAction:function(e,t,a){var n=Array.prototype.slice.call(arguments,3),i=new XMLHttpRequest;i.onload=function(){if(4===i.readyState)switch(i.status,i.status){case 200:a.apply(i,n);break;case 401:localStorage.removeItem("token"),a.apply(i,n);break;default:a.apply(i,n)}},i.callback=a,t.action=e,i.open("POST","/?eID=vinouActions",!0),i.setRequestHeader("Content-type","application/json"),i.send(JSON.stringify(t))},submitAddForm:function(e){var t=this;0===t.quantity?new vDialog({title:"Altersabfrage",description:"Gerne liefern wir Dir Deine Weine. Bitte bestätige uns, dass Du dafür die notwendigen Altersbeschränkungen erfüllst.",yes:"Ja, ich bin 18",no:"Abbrechen",ok:function(){t.addItemToBasket(t.serializeForm(e))}}):t.addItemToBasket(t.serializeForm(e))},bindEvents:function(){for(var e=this,t=(document.getElementById("basket-dropper"),document.querySelectorAll(e.addForms)),a=0;a<t.length;a++){t[a].addEventListener?t[a].addEventListener("submit",(function(t){t.preventDefault(),e.submitAddForm(this)}),!0):t[a].attachEvent("onsubmit",(function(t){t.preventDefault(),e.submitAddForm(this)})),t[a].querySelector(".add-basket").addEventListener("click",(function(t){t.preventDefault(),e.submitAddForm(this.parentNode)}))}var n=document.querySelectorAll("button.inc");for(a=0;a<n.length;a++)n[a].addEventListener("click",(function(t){t.preventDefault();var a=this.parentNode.querySelector('input[name="quantity"]'),n=a.value;e.tempquantity=n;var i=a.getAttribute("max")?a.getAttribute("max"):99;return a.value=n<i?parseInt(n)+1:i,e.setUpdateTimeout(a),!1}));var i=document.querySelectorAll("button.dec");for(a=0;a<i.length;a++)i[a].addEventListener("click",(function(t){t.preventDefault();var a=this.parentNode.querySelector('input[name="quantity"]'),n=a.value;e.tempquantity=n;var i=a.getAttribute("min")?a.getAttribute("min"):1;return a.value=n>i?parseInt(n)-1:i,e.setUpdateTimeout(a),!1}));var s=document.querySelectorAll(e.updateForms);for(a=0;a<s.length;a++){s[a].addEventListener?s[a].addEventListener("submit",(function(t){t.preventDefault(),e.updateBasketItem(e.serializeForm(this))}),!0):s[a].attachEvent("onsubmit",(function(t){t.preventDefault(),e.updateBasketItem(e.serializeForm(this))}));var r=s[a].querySelector('input[name="quantity"]');r.addEventListener("focus",(function(t){e.tempquantity=this.value})),r.addEventListener("blur",(function(t){e.setUpdateTimeout(this)})),r.addEventListener("input",(function(t){e.setUpdateTimeout(this)}))}var o=document.querySelectorAll(e.deleteItemButtons);for(a=0;a<o.length;a++)o[a].addEventListener("click",(function(t){t.preventDefault();var a=this.getAttribute("data-id"),n=this.getAttribute("data-wine-id");return e.deleteItemFromBasket(a,n),!1}));var u=document.querySelector("#deliveryAdress");u&&u.addEventListener("change",(function(){document.querySelector("#delivery-fieldset").setAttribute("data-visible",this.checked?1:0);var e=document.querySelectorAll('#delivery-fieldset [data-required="1"]');this.checked?e.forEach((function(e){e.setAttribute("required","required")})):e.forEach((function(e){e.removeAttribute("required")}))})),e.campaign.hashInput&&e.campaign.hashInput.addEventListener("input",(function(t){e.setCampaignTimeout(this)})),e.campaign.addButton&&e.campaign.addButton.addEventListener("click",(function(t){return t.preventDefault(),e.addCampaign(),!1})),e.campaign.removeButton&&e.campaign.removeButton.addEventListener("click",(function(t){return t.preventDefault(),e.removeCampaign(),!1}))},setUpdateTimeout:function(e){var t=this;clearTimeout(t.timeout),t.timeout=setTimeout((function(){t.tempquantity!=e.value&&e.value>0&&(t.tempquantity=null,t.updateBasketItem(t.serializeForm(e.form)))}),250)},setCampaignTimeout:function(e){var t=this;clearTimeout(t.campaign.check),t.campaign.check=setTimeout((function(){t.temphash!=e.value&&""!=e.value&&(t.temphash=e.value,t.basketAction("findCampaign",{hash:e.value},(function(){campaign=JSON.parse(this.responseText),200==this.status?(t.campaign.data=campaign,t.campaign.addButton.setAttribute("data-status","enabled")):t.campaign.addButton.setAttribute("data-status","disabled")})))}),750)},addCampaign:function(){var e=this,t=!!e.campaign.hashInput&&e.campaign.hashInput.value;if(!t)return!1;e.basketAction("loadCampaign",{hash:t},(function(){if(200===this.status){toast.show("Erfolgreich","Die Kampagne wurde erfolgreich aktiviert");var t=JSON.parse(this.responseText);"absolute"==t.rebate_type&&(t.net=-1*t.net,t.tax=-1*t.tax,t.gross=-1*t.gross),e.campaign.data=t,e.updateBasketCount()}}))},removeCampaign:function(){var e=this;e.campaign.data=!1,e.campaign.discount=!1,e.basketAction("removeCampaign",{},(function(){200===this.status&&e.updateBasketCount()}))},toggleCampaignRow:function(){var e=this,t=document.getElementById("campaign-row");return!!t&&([{field:"name"},{field:"hash"},{field:"id"},{field:"gross"},{field:"description"},{field:"gross",target:"attribute"},{field:"hash",target:"attribute"}].forEach((function(a){var n=a.field,i=t.querySelector('[data-property="campaign-'+n+'"]');if("gross"==n)var s=e.campaign.discount[n]?e.campaign.discount[n].replace(".",",")+" €":"";else s=e.campaign.data[n]?e.campaign.data[n]:"";"attribute"==a.target?(i=t)&&t.setAttribute("data-"+n,s):i&&(i.innerHTML=s)})),t.setAttribute("data-status",e.campaign.data?"visible":"hidden"),!0)},serializeForm:function(e){if(e&&"FORM"===e.nodeName){var t,a,n={};for(t=e.elements.length-1;t>=0;t-=1)if(""!==e.elements[t].name)switch(e.elements[t].nodeName){case"INPUT":switch(e.elements[t].type){case"text":case"number":case"email":case"date":case"hidden":case"password":case"button":case"reset":case"submit":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"checkbox":case"radio":e.elements[t].checked&&(n[e.elements[t].name]=encodeURIComponent(e.elements[t].value))}break;case"file":break;case"TEXTAREA":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"SELECT":switch(e.elements[t].type){case"select-one":n[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"select-multiple":for(a=e.elements[t].options.length-1;a>=0;a-=1)e.elements[t].options[a].selected&&(n[e.elements[t].name]=encodeURIComponent(e.elements[t].options[a].value))}}return n}},isTouchDevice:function(){var e=" -webkit- -moz- -o- -ms- ".split(" ");return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||function(e){return window.matchMedia(e).matches}(["(",e.join("touch-enabled),("),"heartz",")"].join(""))}};vinouShop.init();