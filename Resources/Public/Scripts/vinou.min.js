var t3vinprefix=".tx-vinou ",vinouShop={addForms:t3vinprefix+"form.add-item-form",updateForms:t3vinprefix+"form.edit-item-form",deleteItemButtons:t3vinprefix+"a.delete-basket-item",quantityEditInputs:t3vinprefix+'form.basket-edit-form input[name="quantity"]',card:document.querySelector(".basket-status"),campaign:{hashInput:document.querySelector("input#campaign-code"),check:null,addButton:document.querySelector("a#add-campaign"),removeButton:document.querySelector("a#remove-campaign"),discount:!1,data:!1},token:null,dropper:null,settings:{minBasketSize:null,packageSteps:null},items:[],sum:{quantity:0,bottles:0,net:0,tax:0,gross:0,valid:!1},config:{basket:{messageType:"toast"}},quantity:0,timeout:null,checkBasketTimeout:null,tempquantity:0,temphash:"",errors:{minBasketSize:{title:"Mindestbestellmenge nicht erreicht",description:"Du hast noch nicht die nötige Mindestbestellmenge von <strong>###value### Flaschen</strong> im Warenkorb",type:"error",checkout:"hidden"},packageSteps:{title:"Falsche Bestellmenge",description:"Die größe Deines Warenkorbes entspricht nicht unseren Versandstaffeln. <strong>Wir versenden ###value### Flaschen.</strong> Du möchtest eine Sondergröße beauftragen oder die passende Versandstaffel ist nicht dabei? Dann setz Dich direkt mit uns in Verbindung.",factor:"Die größe Deines Warenkorbes entspricht nicht unseren Versandstaffeln. <strong>Wir versenden ausschließlich Gesamtmengen die durch ###value### teilbar sind.</strong> Du möchtest eine Sondergröße beauftragen? Dann setz Dich direkt mit uns in Verbindung.",type:"error",checkout:"hidden"}},init:function(){this.loadConfig(),this.bindEvents(),this.loadSettings(),this.createDropper(),this.initBasket()},loadConfig:function(){"undefined"!=typeof vinouConfig&&(this.config=vinouConfig)},loadSettings:function(){var e=this;minBasketSize=e.card.getAttribute("data-minbasketsize"),minBasketSize&&parseInt(minBasketSize)>0&&(e.settings.minBasketSize=minBasketSize),packageSteps=e.card.getAttribute("data-packagesteps"),packageSteps&&""!=packageSteps&&(e.settings.packageSteps=packageSteps.split(","))},createDropper:function(){this.dropper=document.createElement("DIV"),this.dropper.id="basket-dropper",document.body.appendChild(this.dropper)},initBasket:function(){campaignRow=document.getElementById("campaign-row"),campaignRow&&campaignRow.getAttribute("data-hash")?this.loadCampaign():this.updateBasketCount()},addItemToBasket:function(e){var t=this,a=document.querySelector(".wine-details"),i=document.getElementById("shop-list-item-"+e.item_id);if(!a&&!i)return!1;var n=a||i,s=n.querySelector(".image img").cloneNode(!0);t.dropper.setAttribute("data-status","visible"),t.dropper.innerHTML="",t.dropper.appendChild(s);var r=n.querySelector(".add-item-form").getBoundingClientRect();t.dropper.style.top=parseInt(r.top)+"px",t.dropper.style.left=parseInt(r.left)+"px";var o=document.querySelector(".basket-status .juwel").getBoundingClientRect();t.dropper.setAttribute("data-status","tobasket"),t.dropper.style.top=parseInt(o.top)+"px",t.dropper.style.left=parseInt(o.left)+"px";setTimeout((function(){t.dropper.setAttribute("data-status","hidden")}),800);var u={data:e};t.basketAction("addItem",u,(function(){if(200===this.status){switch("string"==typeof t.config.basket.messageType?t.config.basket.messageType:"toast"){case"dialog":switch(e.item_type){case"bundle":var a=e.quantity+" Weinpaket(e) ";break;case"product":a=e.quantity+" Stück ";break;default:a=e.quantity+" Flasche(n) "}new vDialog({title:'<span class="fa fa-shopping-cart"></span> Warenkorb',description:"<strong>"+a+"</strong> wurde(n) in den Warenkorb gelegt.",yes:"OK",type:"OK",ok:function(){}});break;case"toast":toast.show("Erfolgreich","Deine Position wurde in den Warenkorb gelegt")}t.updateBasketCount();var i=document.querySelector("#shop-list-item-"+e.item_id+" .basket-overlay");if(i){response=JSON.parse(this.responseText),i.setAttribute("data-status","visible");for(var n=i.querySelectorAll("input"),s=0;s<n.length;s++)response.data[n[s].name]&&(n[s].value=response.data[n[s].name],"quantity"==n[s].name&&t.refreshQuantityOverlay(n[s]))}}}))},deleteItemFromBasket:function(e,t){var a=this,i={id:e},n=document.getElementById("basket-row-"+e);n&&n.setAttribute("data-status","hidden"),a.basketAction("deleteItem",i,(function(){if(200===this.status){n&&n.parentNode.removeChild(n);var e=document.querySelector("#shop-list-item-"+t+" .basket-overlay");e&&e.setAttribute("data-status","hidden"),toast.show("Erfolgreich","Deine Position wurde gelöscht");var i=document.getElementById("campaign-row");i&&i.getAttribute("data-hash")?a.loadCampaign():a.updateBasketCount()}}))},updateBasketItem:function(e){var t=this,a=t.serializeForm(e),i={id:a.id,data:{quantity:a.quantity}};if(a.quantity>0){var n=document.getElementById("basket-row-"+a.id);if(n){var s=n.querySelector(".quantity-overlay");s&&(s.innerHTML=a.quantity);var r=a.quantity*parseFloat(a.gross);n.querySelector(".price strong").innerHTML=r.toFixed(2).replace(".",",")+" €"}t.basketAction("editItem",i,(function(){if(response=JSON.parse(this.responseText),200===this.status){toast.show("Erfolgreich","Deine Position wurde geändert");var e=document.getElementById("campaign-row");e&&e.getAttribute("data-hash")?t.loadCampaign():t.updateBasketCount()}}))}else t.basketAction("deleteItem",{id:a.id},(function(){if(200===this.status){toast.show("Erfolgreich","Deine Position wurde gelöscht");var e=document.getElementById("campaign-row");e&&e.getAttribute("data-hash")?t.loadCampaign():t.updateBasketCount();var i=document.getElementById("basket-row-"+a.id);i&&i.parentNode.removeChild(i)}}))},updateBasketCount:function(){var e=this;e.card.setAttribute("data-status","normal"),e.sum.net=0,e.sum.tax=0,e.sum.gross=0,e.sum.quantity=0,e.sum.visibleQuantity=0,e.basketAction("get",{},(function(){200==this.status&&(response=JSON.parse(this.responseText),e.sum.valid=!!response.valid&&response.valid,response.basketItems?(response.basketItems.forEach((function(t){var a=1;t.item.package_quantity&&parseInt(t.item.package_quantity)>0&&(a=t.item.package_quantity),e.sum.visibleQuantity+=parseInt(t.quantity),e.sum.quantity+=parseInt(t.quantity)*parseInt(a),t.item.prices&&t.item.prices[0]?(e.sum.tax+=t.quantity*t.item.prices[0].tax,e.sum.net+=t.quantity*t.item.prices[0].net,e.sum.gross+=t.quantity*t.item.prices[0].gross):(e.sum.tax+=t.quantity*t.item.tax,e.sum.net+=t.quantity*t.item.net,e.sum.gross+=t.quantity*t.item.gross)})),e.basketAction("findPackage",{type:"bottles",quantity:e.sum.quantity},(function(){response=JSON.parse(this.responseText),packageRow=document.querySelector("#package-row"),response&&response.gross?(e.sum.tax+=1*response.tax,e.sum.net+=1*response.net,e.sum.gross+=1*response.gross,packageGross=response.gross.replace(".",",")+" €"):packageGross="0,00 €",packageRow&&(packagePrice=packageRow.querySelector(".package-price"),packageRow.setAttribute("data-id",response.id),packagePrice&&(packagePrice.innerHTML=packageGross)),e.updateBasketSum()}))):e.updateBasketSum())}))},updateBasketSum:function(){var e=this,t=document.querySelector(".basket-status");for(var a in t&&(t.setAttribute("data-count",e.sum.quantity),e.sum.quantity?(t.classList.add("filled"),t.classList.remove("empty")):(t.classList.add("empty"),t.classList.remove("filled"))),document.querySelector(".basket-status .juwel").innerHTML=e.sum.visibleQuantity,e.quantity=e.sum.quantity,e.card.setAttribute("data-status","updated"),void 0!==e.campaign.discount.gross&&(e.sum.gross=parseFloat(e.sum.gross)+parseFloat(e.campaign.discount.gross),e.sum.net=parseFloat(e.sum.net)+parseFloat(e.campaign.discount.net),e.sum.tax=parseFloat(e.sum.tax)+parseFloat(e.campaign.discount.tax)),e.sum)e.sum.hasOwnProperty(a)&&(el=document.querySelector("#basket-table #basket-sum-"+a),el&&"number"==typeof e.sum[a]&&(el.innerHTML=e.sum[a].toFixed(2).replace(".",",")+" €"));e.setBasketError(e.sum.valid),clearTimeout(e.checkBasketTimeout),e.checkBasketTimeout=setTimeout((function(){e.checkBasketTableVisibility()}),400)},checkBasketTableVisibility:function(){var e=document.getElementById("basket-table");e&&0===this.quantity&&e.parentNode.removeChild(e)},isNumeric:function(e){return/^-?[\d.]+(?:e-?\d+)?$/.test(e)},setBasketError:function(e){var t=this,a=document.getElementById(t3vinprefix+"basket-errors"),i=document.querySelector(t3vinprefix+".basket-controls");if(a){a.innerHTML="";var n="visible";if(t.errors[e]){var s=document.createElement("P");s.className="inline-message basket-warnings",s.setAttribute("data-type",t.errors[e].type);var r=document.createElement("SPAN");r.className="title",r.innerHTML=t.errors[e].title,s.appendChild(r);var o=t.settings[e],u=document.createElement("SPAN");u.className="description","string"!=typeof o&&(o=t.settings[e].join(", ")),t.isNumeric(t.settings[e])>0&&"packageSteps"==e?u.innerHTML=t.errors[e].factor.replace("###value###",o):u.innerHTML=t.errors[e].description.replace("###value###",o),s.appendChild(u),a.appendChild(s),s.setAttribute("data-status","visible"),n=t.errors[e].checkout}i&&i.setAttribute("data-status",n)}},basketAction:function(e,t,a){var i=Array.prototype.slice.call(arguments,3),n=new XMLHttpRequest;n.onload=function(){if(4===n.readyState)switch(n.status,n.status){case 200:default:a.apply(n,i);break;case 401:localStorage.removeItem("token"),a.apply(n,i)}},n.callback=a,t.action=e,n.open("POST","/?vinou-command",!0),n.setRequestHeader("Content-type","application/json"),n.send(JSON.stringify(t))},refreshQuantityOverlay:function(e){var t=e.closest("form").querySelector(".quantity-overlay");t&&(t.innerHTML=parseInt(e.value))},submitAddForm:function(e){var t=this;0===t.quantity?new vDialog({title:"Altersabfrage",description:"Gerne liefern wir Dir Deine Weine. Bitte bestätige uns, dass Du dafür die notwendigen Altersbeschränkungen erfüllst.",yes:"Ja, ich bin 18",no:"Abbrechen",ok:function(){t.addItemToBasket(t.serializeForm(e))}}):t.addItemToBasket(t.serializeForm(e))},bindEvents:function(){for(var e=this,t=(document.getElementById("basket-dropper"),document.querySelectorAll(e.addForms)),a=0;a<t.length;a++){t[a].addEventListener?t[a].addEventListener("submit",(function(t){t.preventDefault(),e.submitAddForm(this)}),!0):t[a].attachEvent("onsubmit",(function(t){t.preventDefault(),e.submitAddForm(this)})),t[a].querySelector(".add-basket").addEventListener("click",(function(t){t.preventDefault(),e.submitAddForm(this.closest("form"))})),(n=t[a].querySelector('[name="quantity"]')).addEventListener("change",(function(t){e.refreshQuantityOverlay(this)}))}var i=document.querySelectorAll(e.updateForms);for(a=0;a<i.length;a++){var n;i[a].addEventListener?i[a].addEventListener("submit",(function(t){t.preventDefault(),e.updateBasketItem(this)}),!0):i[a].attachEvent("onsubmit",(function(t){t.preventDefault(),e.updateBasketItem(this)})),(n=i[a].querySelector('[name="quantity"]')).addEventListener("focus",(function(t){e.tempquantity=this.value})),n.addEventListener("change",(function(t){e.refreshQuantityOverlay(this),e.setUpdateTimeout(this)})),n.addEventListener("blur",(function(t){e.setUpdateTimeout(this)})),n.addEventListener("input",(function(t){e.setUpdateTimeout(this)}))}var s=document.querySelectorAll(t3vinprefix+"button.inc,"+t3vinprefix+"button.dec");for(a=0;a<s.length;a++)s[a].addEventListener("click",(function(t){t.preventDefault();var a=this.form,i=a.querySelector('[name="quantity"]'),n=a.querySelector('[type="submit"]'),s=parseInt(i.value);if(this.getAttribute("class").indexOf("inc")>-1){var r=i.getAttribute("max")?parseInt(i.getAttribute("max")):99;s<r?(e.tempquantity=s,i.value=s+1):i.value=r}if(this.getAttribute("class").indexOf("dec")>-1){var o=i.getAttribute("min")?parseInt(i.getAttribute("min")):1;s>o?(e.tempquantity=s,i.value=s-1):i.value=o}return e.refreshQuantityOverlay(i),a.getAttribute("class").indexOf("edit-item-form")>-1&&!n&&e.setUpdateTimeout(i),!1}));var r=document.querySelectorAll(e.deleteItemButtons);for(a=0;a<r.length;a++)r[a].addEventListener("click",(function(t){t.preventDefault();var a=this.getAttribute("data-id"),i=this.getAttribute("data-wine-id");return e.deleteItemFromBasket(a,i),!1}));var o=document.querySelector("#deliveryAdress");o&&o.addEventListener("change",(function(){document.querySelector("#delivery-fieldset").setAttribute("data-visible",this.checked?1:0);var e=document.querySelectorAll('#delivery-fieldset [data-required="1"]');this.checked?e.forEach((function(e){e.setAttribute("required","required")})):e.forEach((function(e){e.removeAttribute("required")}))})),e.campaign.hashInput&&e.campaign.hashInput.addEventListener("input",(function(t){e.setCampaignTimeout(this)})),e.campaign.addButton&&e.campaign.addButton.addEventListener("click",(function(t){return t.preventDefault(),e.loadCampaign(),!1})),e.campaign.removeButton&&e.campaign.removeButton.addEventListener("click",(function(t){return t.preventDefault(),e.removeCampaign(),!1}));var u=document.querySelectorAll(t3vinprefix+"form");for(a=0;a<u.length;a++)u[a].addEventListener?u[a].addEventListener("submit",(function(t){e.disableForm(this)}),!0):u[a].attachEvent("onsubmit",(function(t){e.disableForm(this)}))},disableForm:function(e){var t=e.querySelector('[type="submit"]');t&&(t.disabled=!0);var a=e.querySelector(".spinner-wrapper");a&&void 0!==a&&(a.style.display="block")},setUpdateTimeout:function(e){var t=this;clearTimeout(t.timeout),t.timeout=setTimeout((function(){t.tempquantity!=e.value&&e.value>0&&(t.tempquantity=null,t.updateBasketItem(e.form))}),750)},collectBasketData:function(){var e=this;e.items=[];for(var t=document.querySelectorAll(t3vinprefix+".item-row"),a=0;a<t.length;a++){var i=t[a];if("campaign-row"!=i.id){var n=i.querySelector("form");if("package-row"==i.id){var s={item_type:"package",item_id:i.getAttribute("data-id"),quantity:1,net:i.getAttribute("data-net"),tax:i.getAttribute("data-tax"),taxrate:i.getAttribute("data-taxrate"),gross:i.getAttribute("data-gross")};e.items.push(s)}else{if(void 0===n)continue;var r=e.serializeForm(n);(s={quantity:r.quantity,gross:(r.quantity*r.gross).toFixed(2),taxrate:r.taxrate,item_type:r.item_type,item_id:r.item_id}).net=(s.gross/(1+s.taxrate/100)).toFixed(2),s.tax=(s.gross-s.net).toFixed(2),e.items.push(s)}}}},setCampaignTimeout:function(e){var t=this;clearTimeout(t.campaign.check),t.campaign.check=setTimeout((function(){if(t.temphash!=e.value&&""!=e.value){if(e.disabled=!0,"string"==typeof t.campaign.data.hash&&t.campaign.data.hash==e.value)return e.value="",!1;var a=document.querySelector("#campaign-table .loader");a&&a.setAttribute("data-status","visible"),t.temphash=e.value,t.collectBasketData(),t.basketAction("findCampaign",{hash:e.value,items:t.items},(function(){var i=JSON.parse(this.responseText);if(e.disabled=!1,a&&a.setAttribute("data-status","hidden"),200==this.status&&"success"==i.info)t.campaign.addButton.setAttribute("data-status","enabled");else{if(null!=i.errors)var n=null!=typeof i.errors[0]?i.errors[0]:i.data;else if("undefined"!=i.data)n=i.data;else n="";if("ERROR_MIN_QUANTITY_NOT_REACHED"===n)var s="Mindeststückzahl für den Rabatt-Code nicht erreicht!";else s="Rabatt-Code konnte nicht gefunden werden!";toast.show("Fehler!",s),t.campaign.addButton.setAttribute("data-status","disabled")}}))}}),750)},loadCampaign:function(){var e=this,t=!1,a=document.querySelector("#campaign-row");if(a&&""!=a.getAttribute("data-hash")&&(t=a.getAttribute("data-hash")),e.campaign.hashInput&&""!=e.campaign.hashInput.value&&(t=e.campaign.hashInput.value),!t)return!1;e.campaign.data=!1,e.campaign.discount=!1,e.collectBasketData(),e.basketAction("loadCampaign",{hash:t,items:e.items},(function(){var t=JSON.parse(this.responseText);if(200==this.status){e.campaign.data=t.data,e.campaign.discount=t.summary,e.campaign.hashInput.value="",a.setAttribute("data-hash",t.data.hash),e.campaign.addButton.setAttribute("data-status","disabled");var i=document.getElementById("campaign-table");i&&i.setAttribute("data-status","hidden")}else{if("ERROR_MIN_QUANTITY_NOT_REACHED"===(void 0!==t.errors[0]?t.errors[0]:t.data))var n="Mindeststückzahl für den Rabatt-Code nicht erreicht!";else n="Rabatt-Code konnte nicht gefunden werden!";n&&toast.show("Fehler!",n)}e.toggleCampaignRow()}))},removeCampaign:function(){var e=this;e.campaign.data=!1,e.campaign.discount=!1,e.basketAction("removeCampaign",{},(function(){200===this.status&&(e.campaign.data=!1,e.campaign.discount=!1,e.toggleCampaignRow())}))},toggleCampaignRow:function(){var e=this,t=document.getElementById("campaign-row");return!!t&&([{field:"name"},{field:"hash"},{field:"id"},{field:"gross"},{field:"description"},{field:"gross",target:"attribute"},{field:"hash",target:"attribute"}].forEach((function(a){var i=a.field,n=t.querySelector('[data-property="campaign-'+i+'"]');if("gross"==i)var s=e.campaign.discount[i]?e.campaign.discount[i].replace(".",",")+" €":"";else s=e.campaign.data[i]?e.campaign.data[i]:"";"attribute"==a.target?(n=t)&&t.setAttribute("data-"+i,s):n&&(n.innerHTML=s)})),t.setAttribute("data-status",e.campaign.data?"visible":"hidden"),e.updateBasketCount(),!0)},serializeForm:function(e){if(e&&"FORM"===e.nodeName){var t,a,i={};for(t=e.elements.length-1;t>=0;t-=1)if(""!==e.elements[t].name)switch(e.elements[t].nodeName){case"INPUT":switch(e.elements[t].type){case"text":case"number":case"email":case"date":case"hidden":case"password":case"button":case"reset":case"submit":i[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"checkbox":case"radio":e.elements[t].checked&&(i[e.elements[t].name]=encodeURIComponent(e.elements[t].value))}break;case"file":break;case"TEXTAREA":i[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"SELECT":switch(e.elements[t].type){case"select-one":i[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"select-multiple":for(a=e.elements[t].options.length-1;a>=0;a-=1)e.elements[t].options[a].selected&&(i[e.elements[t].name]=encodeURIComponent(e.elements[t].options[a].value))}}return i}},isTouchDevice:function(){var e=" -webkit- -moz- -o- -ms- ".split(" ");return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||function(e){return window.matchMedia(e).matches}(["(",e.join("touch-enabled),("),"heartz",")"].join(""))}};vinouShop.init();var vinouList={searchMap:[],list:null,allowedFilter:["place","type","vintage","categories"],arrayProperties:["categories"],clusterSelector:".vinou-cluster-item",containerId:"vinou-list",container:null,options:{valueNames:[{data:["name","vintage","place","type","categories"]}],page:5,pagination:!0},init:function(){this.container=document.getElementById(this.containerId),this.container&&(this.initOptions(),this.initList(),this.loadFilter(),this.bindEvents(),this.initialSearch())},initOptions:function(){$this=this,$this.options.page=document.getElementById($this.containerId).getAttribute("data-items-per-page")},initList:function(){$this=this,$this.list=new List($this.containerId,$this.options),$this.list.sort("sorting",{order:"asc",alphabet:'0123456789AaBbCcDdEÉeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvXxYyZzÅåÄäÖö@"'}),$this.list.update()},isEmpty:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},loadFilter:function(){$this=this;var e=new URL(window.location.href);$this.allowedFilter.forEach((function(t){var a=e.searchParams.get(t);if(a){var i="cluster["+t+"]["+a+"]";document.getElementById(i).checked=!0,$this.searchMap[t]=[],$this.searchMap[t].push(a),document.querySelector("#"+t+"-cluster-group h3").setAttribute("data-status","open"),document.querySelector("#"+t+"-cluster-group ul").style.display="block"}})),$this.filterList()},initialSearch:function(){var e=new URL(window.location.href).searchParams.get("search");e&&(document.getElementById("search-phrase").value=e,this.list.search(e))},filterList:function(){$this=this,$this.list.filter((function(e){for(var t in $this.searchMap)if($this.arrayProperties.indexOf(t)>-1&&e.values()[t]){var a=e.values()[t].split(", "),i=!1;if(a.forEach((function(e){$this.searchMap[t].indexOf(e)>-1&&(i=!0)})),!i)return!1}else if(-1===$this.searchMap[t].indexOf(e.values()[t]))return!1;return!0})),$this.list.update()},bindEvents:function(){for(var e=this,t=document.querySelectorAll(e.clusterSelector),a=0;a<t.length;a++)t[a].addEventListener("change",(function(){var t=this.getAttribute("data-name");if(this.checked)void 0===e.searchMap[t]&&(e.searchMap[t]=[]),e.searchMap[t].push(this.value);else{if(void 0!==e.searchMap[t]){var a=e.searchMap[t].indexOf(this.value);-1!==a&&e.searchMap[t].splice(a,1)}0==e.searchMap[t].length&&delete e.searchMap[t]}e.filterList()}));var i=document.querySelectorAll(".pagination");for(a=0;a<i.length;a++)i[a].addEventListener("click",(function(t){if(t.target&&"page"==t.target.className){var a=document.getElementById(e.containerId);window.scrollTo(a.offsetLeft,a.offsetTop)}}));document.getElementById("search-phrase").addEventListener("keyup",(function(){e.list.search(this.value)}))}};vinouList.init();