var vinouShop={addForms:"form.add-item-form",updateForms:"form.basket-edit-form",deleteItemButtons:"a.delete-basket-item",quantityEditInputs:'form.basket-edit-form input[name="quantity"]',token:null,dropper:null,init:function(){this.validateLogin(),this.bindEvents(),this.createDropper()},createDropper:function(){this.dropper=document.createElement("DIV"),this.dropper.id="basket-dropper",document.body.appendChild(this.dropper)},addItemToBasket:function(e){var t=this,s=document.querySelector("#wine-detail .wine-image"),a=document.getElementById("shop-list-item-"+e.item_id);if(!s&&!a)return!1;var n=s||a,o=n.querySelector("img").cloneNode(!0);t.dropper.setAttribute("data-status","visible"),t.dropper.innerHTML="",t.dropper.appendChild(o);var i=n.getBoundingClientRect();t.dropper.style.top=parseInt(i.top)+"px",t.dropper.style.left=parseInt(i.left)+"px";var r=document.querySelector(".basket-status .juwel").getBoundingClientRect();t.dropper.setAttribute("data-status","tobasket"),t.dropper.style.top=parseInt(r.top)+"px",t.dropper.style.left=parseInt(r.left)+"px";setTimeout(function(){t.dropper.setAttribute("data-status","hidden")},800);var u=localStorage.getItem("basket"),d={uuid:u,data:e};t.doApiRequest("/service/baskets/addItem",d,function(){200===this.status&&t.updateBasketCount(u)})},deleteItemFromBasket:function(e){var t=this,s=localStorage.getItem("basket"),a={id:e};t.doApiRequest("/service/baskets/deleteItem",a,function(){if(200===this.status){t.updateBasketCount(s);var a=document.getElementById("basket-row-"+e);a.parentNode.removeChild(a)}})},updateBasketItem:function(e){var t=this,s=localStorage.getItem("basket"),a={id:e.id,data:{quantity:e.quantity}};if(e.quantity>0){var n=document.getElementById("basket-row-"+e.id),o=e.quantity*parseFloat(e.price);n.querySelector(".position-price").innerHTML=o.toFixed(2)+" €",t.doApiRequest("/service/baskets/editItem",a,function(){200===this.status&&t.updateBasketCount(s)})}else t.doApiRequest("/service/baskets/deleteItem",{id:e.id},function(){if(200===this.status){t.updateBasketCount(s);var a=document.getElementById("basket-row-"+e.id);a.parentNode.removeChild(a)}})},validateBasket:function(){var e=localStorage.getItem("basket");e?(this.setCookie("basket",e,30),this.updateBasketCount(e)):this.createBasket()},updateBasketCount:function(e){var t=this,s=document.querySelector(".basket-status");s.setAttribute("data-status","normal"),t.doApiRequest("/service/baskets/get",{uuid:e},function(){if(200==this.status){response=JSON.parse(this.responseText);var e={quantity:0,net:0,tax:0,gross:0};response.data.basketItems.forEach(function(t){e.quantity+=t.quantity,t.object.price?e.gross+=t.quantity*t.object.price:e.gross+=t.quantity*t.object.gross}),t.doApiRequest("/service/packaging/find",{type:"bottles",bottles:e.quantity},function(){response=JSON.parse(this.responseText),response.data&&(price=response.data.price,e.gross+=1*price,price.replace(".",","),packagePrice=document.querySelector("#package-row .position-price"),packagePrice&&(packagePrice.innerHTML=price+" €")),e.net=e.gross/1.19,e.tax=e.gross-e.net,document.querySelector(".basket-status .juwel").innerHTML=e.quantity,s.setAttribute("data-status","updated"),t.updateBasketSum(e)})}else t.createBasket()})},updateBasketSum:function(e){const t=Object.entries(e);for(const[e,a]of t)if(el=document.getElementById("basket-sum-"+e),el){var s=a.toFixed(2);s.replace(".",","),el.innerHTML=s+" €"}},createBasket:function(){var e=this;e.doApiRequest("/service/baskets/add",null,function(){200===this.status&&(response=JSON.parse(this.responseText),localStorage.setItem("basket",response.data.uuid),e.setCookie("basket",response.data.uuid,30))})},validateLogin:function(){var e=this;localStorage.getItem("token")?e.doApiRequest("/service/check/login",null,function(){200==this.status?e.validateBasket():e.login()}):e.login()},login:function(){var e=this;this.request("/?eID=clientLogin",null,function(){switch(this.status){case 200:response=JSON.parse(this.responseText),response.token&&localStorage.setItem("token",response.token),e.validateBasket()}})},request:function(e,t=null,s){var a=Array.prototype.slice.call(arguments,3),n=new XMLHttpRequest;n.onload=function(){if(4===n.readyState)switch(n.status){case 200:case 401:default:s.apply(n,a)}},n.callback=s,n.open("POST",e,!0),n.setRequestHeader("Content-type","application/json"),n.send(JSON.stringify(t))},doApiRequest:function(e,t=null,s){var a=Array.prototype.slice.call(arguments,3),n=new XMLHttpRequest;n.onload=function(){if(4===n.readyState)switch(n.status){case 200:s.apply(n,a);break;case 401:localStorage.removeItem("token"),s.apply(n,a);break;default:s.apply(n,a)}},n.callback=s,n.open("POST","https://api.vinou.de"+e,!0),n.setRequestHeader("Content-type","application/json"),n.setRequestHeader("Authorization","Bearer "+localStorage.getItem("token")),n.send(JSON.stringify(t))},bindEvents:function(){for(var e=this,t=(document.getElementById("basket-dropper"),document.querySelectorAll(e.addForms)),s=0;s<t.length;s++)t[s].addEventListener?t[s].addEventListener("submit",function(t){t.preventDefault(),e.addItemToBasket(e.serializeForm(this))},!0):t[s].attachEvent("onsubmit",function(t){t.preventDefault(),e.addItemToBasket(e.serializeForm(this))});var a=document.querySelectorAll(e.updateForms);for(s=0;s<a.length;s++)a[s].addEventListener?a[s].addEventListener("submit",function(t){t.preventDefault(),e.updateBasketItem(e.serializeForm(this))},!0):a[s].attachEvent("onsubmit",function(t){t.preventDefault(),e.updateBasketItem(e.serializeForm(this))});var n=document.querySelectorAll(e.deleteItemButtons);for(s=0;s<n.length;s++)n[s].addEventListener("click",function(t){t.preventDefault();var s=this.getAttribute("data-id");return e.deleteItemFromBasket(s),!1});var o=document.querySelector("#deliveryAdress");o&&o.addEventListener("change",function(){document.querySelector("#delivery-fieldset").setAttribute("data-visible",this.checked?1:0);var e=document.querySelectorAll('#delivery-fieldset [data-required="1"]');this.checked?e.forEach(function(e){e.setAttribute("required","required")}):e.forEach(function(e){e.removeAttribute("required")})})},serializeForm:function(e){if(e&&"FORM"===e.nodeName){var t,s,a={};for(t=e.elements.length-1;t>=0;t-=1)if(""!==e.elements[t].name)switch(e.elements[t].nodeName){case"INPUT":switch(e.elements[t].type){case"text":case"number":case"email":case"date":case"hidden":case"password":case"button":case"reset":case"submit":a[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"checkbox":case"radio":e.elements[t].checked&&(a[e.elements[t].name]=encodeURIComponent(e.elements[t].value))}break;case"file":break;case"TEXTAREA":a[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"SELECT":switch(e.elements[t].type){case"select-one":a[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"select-multiple":for(s=e.elements[t].options.length-1;s>=0;s-=1)e.elements[t].options[s].selected&&(a[e.elements[t].name]=encodeURIComponent(e.elements[t].options[s].value))}}return a}},setCookie:function(e,t,s){var a=new Date;a.setTime(a.getTime()+24*s*60*60*1e3);var n="expires="+a.toUTCString();document.cookie=e+"="+t+"; "+n+"; path=/"},getCookie:function(e){for(var t=e+"=",s=document.cookie.split(";"),a=0;a<s.length;a++){for(var n=s[a];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}};vinouShop.init();