var vinouEnquiry={wines:document.querySelectorAll('input[name*="[quantity]"]'),init:function(){this.bindEvents()},calculateSum:function(){for(var e=0,t=0;t<this.wines.length;t++)if(this.wines[t].value>0){var i=this.wines[t].id.replace("quantity","price"),s=document.getElementById(i);e+=parseFloat(s.value)*parseInt(this.wines[t].value)}var n=e.toFixed(2)/1.19,a=parseFloat(e.toFixed(2))-parseFloat(n.toFixed(2));document.getElementById("tx_vinou_enquiry[net]").value=n.toFixed(2),document.getElementById("tx_vinou_enquiry[tax]").value=a.toFixed(2),document.getElementById("tx_vinou_enquiry[gross]").value=e.toFixed(2)},bindEvents:function(){for(var e=this,t=0;t<e.wines.length;t++)e.wines[t].addEventListener("input",function(){e.calculateSum()})}};vinouEnquiry.init();var vinouList={searchMap:[],list:null,allowedFilter:["place","type","vintage","categories"],arrayProperties:["categories"],clusterClass:".vinou-cluster-item",containerId:"vinou-shoplist",container:null,options:{valueNames:[{data:["name","vintage","place","type","categories"]}],page:5,pagination:!0},init:function(){this.container=document.getElementById(this.containerId),this.container&&(this.initOptions(),this.initList(),this.loadFilter(),this.bindEvents(),this.initialSearch())},initOptions:function(){$this=this,$this.options.page=document.getElementById("vinou-shoplist").getAttribute("data-items-per-page")},initList:function(){$this=this,$this.list=new List("vinou-shoplist",$this.options),$this.list.sort("sorting",{order:"asc",alphabet:'0123456789AaBbCcDdEÉeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvXxYyZzÅåÄäÖö@"'}),$this.list.update()},isEmpty:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},loadFilter:function(){$this=this;var e=new URL(window.location.href);$this.allowedFilter.forEach(function(t){var i=e.searchParams.get(t);if(i){var s="cluster["+t+"]["+i+"]";document.getElementById(s).checked=!0,$this.searchMap[t]=[],$this.searchMap[t].push(i),document.querySelector("#"+t+"-cluster-group h3").setAttribute("data-status","open"),document.querySelector("#"+t+"-cluster-group ul").style.display="block"}}),$this.filterList()},initialSearch:function(){var e=new URL(window.location.href).searchParams.get("search");e&&(document.getElementById("search-phrase").value=e,this.list.search(e))},filterList:function(){$this=this,$this.list.filter(function(e){for(var t in $this.searchMap)if($this.arrayProperties.indexOf(t)>-1&&e.values()[t]){var i=e.values()[t].split(", "),s=!1;if(i.forEach(function(e){$this.searchMap[t].indexOf(e)>-1&&(s=!0)}),!s)return!1}else if(-1===$this.searchMap[t].indexOf(e.values()[t]))return!1;return!0}),$this.list.update()},bindEvents:function(){for(var e=this,t=document.querySelectorAll(e.clusterClass),i=0;i<t.length;i++)t[i].addEventListener("change",function(){var t=this.getAttribute("data-name");if(this.checked)void 0===e.searchMap[t]&&(e.searchMap[t]=[]),e.searchMap[t].push(this.value);else{if(void 0!==e.searchMap[t]){var i=e.searchMap[t].indexOf(this.value);-1!==i&&e.searchMap[t].splice(i,1)}0==e.searchMap[t].length&&delete e.searchMap[t]}e.filterList()});var s=document.querySelectorAll(".pagination");for(i=0;i<s.length;i++)s[i].addEventListener("click",function(t){if(t.target&&"page"==t.target.className){var i=document.getElementById(e.containerId);window.scrollTo(i.offsetLeft,i.offsetTop)}});document.getElementById("search-phrase").addEventListener("keyup",function(){e.list.search(this.value)})}};vinouList.init();var vinouShop={addForms:"form.add-item-form",updateForms:"form.basket-edit-form",deleteItemButtons:"a.delete-basket-item",quantityEditInputs:'form.basket-edit-form input[name="quantity"]',token:null,dropper:null,init:function(){this.validateLogin(),this.bindEvents(),this.createDropper()},createDropper:function(){this.dropper=document.createElement("DIV"),this.dropper.id="basket-dropper",document.body.appendChild(this.dropper)},addItemToBasket:function(e){var t=this,i=document.querySelector("#wine-detail .wine-image"),s=document.getElementById("shop-list-item-"+e.item_id);if(!i&&!s)return!1;var n=i||s,a=n.querySelector("img").cloneNode(!0);t.dropper.setAttribute("data-status","visible"),t.dropper.innerHTML="",t.dropper.appendChild(a);var r=n.getBoundingClientRect();t.dropper.style.top=parseInt(r.top)+"px",t.dropper.style.left=parseInt(r.left)+"px";var o=document.querySelector(".basket-status .juwel").getBoundingClientRect();t.dropper.setAttribute("data-status","tobasket"),t.dropper.style.top=parseInt(o.top)+"px",t.dropper.style.left=parseInt(o.left)+"px";setTimeout(function(){t.dropper.setAttribute("data-status","hidden")},800);var u=localStorage.getItem("basket"),c={uuid:u,data:e};t.doApiRequest("/service/baskets/addItem",c,function(){200===this.status&&t.updateBasketCount(u)})},deleteItemFromBasket:function(e){var t=this,i=localStorage.getItem("basket"),s={id:e};t.doApiRequest("/service/baskets/deleteItem",s,function(){if(200===this.status){t.updateBasketCount(i);var s=document.getElementById("basket-row-"+e);s.parentNode.removeChild(s)}})},updateBasketItem:function(e){var t=this,i=localStorage.getItem("basket"),s={id:e.id,data:{quantity:e.quantity}};if(e.quantity>0){var n=document.getElementById("basket-row-"+e.id),a=e.quantity*parseFloat(e.price);n.querySelector(".position-price").innerHTML=a.toFixed(2)+" €",t.doApiRequest("/service/baskets/editItem",s,function(){200===this.status&&t.updateBasketCount(i)})}else t.doApiRequest("/service/baskets/deleteItem",{id:e.id},function(){if(200===this.status){t.updateBasketCount(i);var s=document.getElementById("basket-row-"+e.id);s.parentNode.removeChild(s)}})},validateBasket:function(){var e=localStorage.getItem("basket");e?(this.setCookie("basket",e,30),this.updateBasketCount(e)):this.createBasket()},updateBasketCount:function(e){var t=this,i=document.querySelector(".basket-status");i.setAttribute("data-status","normal"),t.doApiRequest("/service/baskets/get",{uuid:e},function(){if(200==this.status){response=JSON.parse(this.responseText);var e={quantity:0,net:0,tax:0,gross:0};response.data.basketItems.forEach(function(t){e.quantity+=t.quantity,t.object.price?e.gross+=t.quantity*t.object.price:e.gross+=t.quantity*t.object.gross}),t.doApiRequest("/service/packaging/find",{type:"bottles",bottles:e.quantity},function(){response=JSON.parse(this.responseText),response.data&&(price=response.data.price,e.gross+=1*price,price.replace(".",","),packagePrice=document.querySelector("#package-row .position-price"),packagePrice&&(packagePrice.innerHTML=price+" €")),e.net=e.gross/1.19,e.tax=e.gross-e.net,document.querySelector(".basket-status .juwel").innerHTML=e.quantity,i.setAttribute("data-status","updated"),t.updateBasketSum(e)})}else t.createBasket()})},updateBasketSum:function(e){const t=Object.entries(e);for(const[e,s]of t)if(el=document.getElementById("basket-sum-"+e),el){var i=s.toFixed(2);i.replace(".",","),el.innerHTML=i+" €"}},createBasket:function(){var e=this;e.doApiRequest("/service/baskets/add",null,function(){200===this.status&&(response=JSON.parse(this.responseText),localStorage.setItem("basket",response.data.uuid),e.setCookie("basket",response.data.uuid,30))})},validateLogin:function(){var e=this;localStorage.getItem("token")?e.doApiRequest("/service/check/login",null,function(){200==this.status?e.validateBasket():e.login()}):e.login()},login:function(){var e=this;this.request("/?eID=clientLogin",null,function(){switch(this.status){case 200:response=JSON.parse(this.responseText),response.token&&localStorage.setItem("token",response.token),e.validateBasket()}})},request:function(e,t=null,i){var s=Array.prototype.slice.call(arguments,3),n=new XMLHttpRequest;n.onload=function(){if(4===n.readyState)switch(n.status){case 200:case 401:default:i.apply(n,s)}},n.callback=i,n.open("POST",e,!0),n.setRequestHeader("Content-type","application/json"),n.send(JSON.stringify(t))},doApiRequest:function(e,t=null,i){var s=Array.prototype.slice.call(arguments,3),n=new XMLHttpRequest;n.onload=function(){if(4===n.readyState)switch(n.status){case 200:i.apply(n,s);break;case 401:localStorage.removeItem("token"),i.apply(n,s);break;default:i.apply(n,s)}},n.callback=i,n.open("POST","https://api.vinou.de"+e,!0),n.setRequestHeader("Content-type","application/json"),n.setRequestHeader("Authorization","Bearer "+localStorage.getItem("token")),n.send(JSON.stringify(t))},bindEvents:function(){for(var e=this,t=(document.getElementById("basket-dropper"),document.querySelectorAll(e.addForms)),i=0;i<t.length;i++)t[i].addEventListener?t[i].addEventListener("submit",function(t){t.preventDefault(),e.addItemToBasket(e.serializeForm(this))},!0):t[i].attachEvent("onsubmit",function(t){t.preventDefault(),e.addItemToBasket(e.serializeForm(this))});var s=document.querySelectorAll(e.updateForms);for(i=0;i<s.length;i++)s[i].addEventListener?s[i].addEventListener("submit",function(t){t.preventDefault(),e.updateBasketItem(e.serializeForm(this))},!0):s[i].attachEvent("onsubmit",function(t){t.preventDefault(),e.updateBasketItem(e.serializeForm(this))});var n=document.querySelectorAll(e.deleteItemButtons);for(i=0;i<n.length;i++)n[i].addEventListener("click",function(t){t.preventDefault();var i=this.getAttribute("data-id");return e.deleteItemFromBasket(i),!1});var a=document.querySelector("#deliveryAdress");a&&a.addEventListener("change",function(){document.querySelector("#delivery-fieldset").setAttribute("data-visible",this.checked?1:0);var e=document.querySelectorAll('#delivery-fieldset [data-required="1"]');this.checked?e.forEach(function(e){e.setAttribute("required","required")}):e.forEach(function(e){e.removeAttribute("required")})})},serializeForm:function(e){if(e&&"FORM"===e.nodeName){var t,i,s={};for(t=e.elements.length-1;t>=0;t-=1)if(""!==e.elements[t].name)switch(e.elements[t].nodeName){case"INPUT":switch(e.elements[t].type){case"text":case"number":case"email":case"date":case"hidden":case"password":case"button":case"reset":case"submit":s[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"checkbox":case"radio":e.elements[t].checked&&(s[e.elements[t].name]=encodeURIComponent(e.elements[t].value))}break;case"file":break;case"TEXTAREA":s[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"SELECT":switch(e.elements[t].type){case"select-one":s[e.elements[t].name]=encodeURIComponent(e.elements[t].value);break;case"select-multiple":for(i=e.elements[t].options.length-1;i>=0;i-=1)e.elements[t].options[i].selected&&(s[e.elements[t].name]=encodeURIComponent(e.elements[t].options[i].value))}}return s}},setCookie:function(e,t,i){var s=new Date;s.setTime(s.getTime()+24*i*60*60*1e3);var n="expires="+s.toUTCString();document.cookie=e+"="+t+"; "+n+"; path=/"},getCookie:function(e){for(var t=e+"=",i=document.cookie.split(";"),s=0;s<i.length;s++){for(var n=i[s];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}};vinouShop.init();